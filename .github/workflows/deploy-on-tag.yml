name: Deploy Micro App on Tag

on:
  push:
    tags:
      - 'shared/*'
      - 'header-app/*'
      - 'pip-app/*'
      - 'micro-app-1/*'
      - 'micro-app-2/*'

env:
  AWS_REGION: us-east-1
  PNPM_VERSION: 8

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract app name and version from tag
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          APP_NAME=$(echo $TAG_NAME | cut -d'/' -f1)
          VERSION=$(echo $TAG_NAME | cut -d'/' -f2)
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          echo "ðŸš€ Deploying $APP_NAME version $VERSION"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ì •ë³´ í•„ìš”)
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            apps/*/node_modules
            shared/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: |
            apps/*/dist
            shared/dist
          key: ${{ runner.os }}-build-${{ steps.extract.outputs.app_name }}-${{ hashFiles(format('{0}/**', steps.extract.outputs.app_name == 'shared' && 'shared' || format('apps/{0}', steps.extract.outputs.app_name))) }}
          restore-keys: |
            ${{ runner.os }}-build-${{ steps.extract.outputs.app_name }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build app
        run: |
          APP_NAME="${{ steps.extract.outputs.app_name }}"
          
          if [ "$APP_NAME" = "shared" ]; then
            echo "Building shared module..."
            pnpm --filter @mfa/shared build
          else
            echo "Building $APP_NAME..."
            pnpm --filter @mfa/$APP_NAME build
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # TODO: Role ê¸°ë°˜ ì¸ì¦ìœ¼ë¡œ ë³€ê²½ ì˜ˆì •
          role-to-assume: ${{ secrets.SHAREDSERVICE_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          # ìž„ì‹œë¡œ ì•¡ì„¸ìŠ¤ í‚¤ ë°©ì‹ ì§€ì›
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Set S3 bucket name
        id: s3-config
        run: |
          APP_NAME="${{ steps.extract.outputs.app_name }}"
          
          # í™˜ê²½ë³„ ë²„í‚· ì´ë¦„ ì„¤ì • (ì¶”í›„ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬ ê°€ëŠ¥)
          BUCKET_NAME="mfa-${APP_NAME}-prod"
          
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Target S3 bucket: $BUCKET_NAME"

      - name: Deploy to S3
        run: |
          APP_NAME="${{ steps.extract.outputs.app_name }}"
          VERSION="${{ steps.extract.outputs.version }}"
          BUCKET_NAME="${{ steps.s3-config.outputs.bucket_name }}"
          
          # ë¹Œë“œ íŒŒì¼ ê²½ë¡œ ì„¤ì •
          if [ "$APP_NAME" = "shared" ]; then
            DIST_PATH="shared/dist"
          else
            DIST_PATH="apps/$APP_NAME/dist"
          fi
          
          echo "ðŸ“¤ Uploading $DIST_PATH to s3://$BUCKET_NAME"
          
          # ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ S3 ì—…ë¡œë“œ
          aws s3 sync $DIST_PATH s3://$BUCKET_NAME \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive REPLACE \
            --metadata "version=$VERSION,app=$APP_NAME,build-time=$(date -u +%Y-%m-%dT%H:%M:%SZ),git-commit=$GITHUB_SHA"
          
          echo "âœ… S3 upload completed"

      - name: Get CloudFront Distribution ID
        id: cloudfront-config
        run: |
          BUCKET_NAME="${{ steps.s3-config.outputs.bucket_name }}"
          
          # S3 ë„ë©”ì¸ìœ¼ë¡œ CloudFront Distribution ì°¾ê¸°
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${BUCKET_NAME}.s3.${AWS_REGION}.amazonaws.com\`].Id" \
            --output text)
          
          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
            echo "â˜ï¸ Found CloudFront Distribution: $DISTRIBUTION_ID"
          else
            echo "âš ï¸ CloudFront Distribution not found for bucket: $BUCKET_NAME"
            echo "distribution_id=" >> $GITHUB_OUTPUT
          fi

      - name: Invalidate CloudFront
        if: steps.cloudfront-config.outputs.distribution_id != ''
        run: |
          DISTRIBUTION_ID="${{ steps.cloudfront-config.outputs.distribution_id }}"
          
          echo "ðŸ”„ Creating CloudFront invalidation..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
          
          # ë¬´íš¨í™” ì™„ë£Œ ëŒ€ê¸° (ì„ íƒì‚¬í•­)
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID
          
          echo "ðŸŽ‰ CloudFront invalidation completed"

      - name: Deployment summary
        if: always()
        run: |
          APP_NAME="${{ steps.extract.outputs.app_name }}"
          VERSION="${{ steps.extract.outputs.version }}"
          BUCKET_NAME="${{ steps.s3-config.outputs.bucket_name }}"
          
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì•±**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**ë²„ì „**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**S3 ë²„í‚·**: $BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront**: ${{ steps.cloudfront-config.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹**: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ì ‘ì† URL" >> $GITHUB_STEP_SUMMARY
          echo "S3: https://$BUCKET_NAME.s3.$AWS_REGION.amazonaws.com" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.cloudfront-config.outputs.distribution_id }}" ]; then
            CLOUDFRONT_DOMAIN=$(aws cloudfront get-distribution \
              --id ${{ steps.cloudfront-config.outputs.distribution_id }} \
              --query 'Distribution.DomainName' \
              --output text)
            echo "CloudFront: https://$CLOUDFRONT_DOMAIN" >> $GITHUB_STEP_SUMMARY
          fi